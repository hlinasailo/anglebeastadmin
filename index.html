<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Upload & Manage</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBNPSB13qV5YLoxMcc5YmuonTGDVkElBVg",
      authDomain: "lims-e4809.firebaseapp.com",
      projectId: "lims-e4809",
      storageBucket: "lims-e4809.firebasestorage.app",
      messagingSenderId: "702617555933",
      appId: "1:702617555933:web:db2f04cbb09f29354d9c34",
      measurementId: "G-W0KZRR52T2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const cloudName = "de2szhnwu";
    const uploadPreset = "limsailo3";

    // ------------------ IMAGE UPLOAD ------------------
    window.submitForm = async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const file = document.getElementById("fileInput").files[0];
      const resultDiv = document.getElementById("result");

      if (!title || !description || !file) return alert("Please fill all fields and select an image.");
      resultDiv.innerHTML = "<p>Uploading... Please wait.</p>";

      try {
        const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);

        const res = await fetch(url, { method: "POST", body: formData });
        const data = await res.json();
        if (!data.secure_url) throw new Error("Upload failed.");

        await addDoc(collection(db, "gallery"), {
          title,
          description,
          imageUrl: data.secure_url,
          publicId: data.public_id,
          createdAt: serverTimestamp()
        });

        resultDiv.innerHTML = `<p style="color:lightgreen;">‚úÖ Upload Successful!</p>`;
        document.getElementById("uploadForm").reset();
        loadImages();
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "<p style='color:red;'>‚ùå Upload failed</p>";
      }
    };

    async function loadImages() {
      const snapshot = await getDocs(collection(db, "gallery"));
      const listDiv = document.getElementById("imageList");
      listDiv.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const div = document.createElement("div");
        div.style.margin = "20px 0";
        div.style.padding = "12px";
        div.style.background = "#1e293b";
        div.style.borderRadius = "8px";
        div.innerHTML = `
          <p><strong>${data.title}</strong></p>
          <img src="${data.imageUrl}" width="200" style="border-radius:8px;">
          <br>
          <button onclick="deleteImage('${id}', '${data.publicId}')">Delete</button>
        `;
        listDiv.appendChild(div);
      });
    }

    window.deleteImage = async (docId, publicId) => {
      if (!confirm("Are you sure you want to delete this image?")) return;
      try {
        await fetch("https://angelbeast-backend-1.onrender.com/delete-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ publicId })
        });
        await deleteDoc(doc(db, "gallery", docId));
        loadImages();
      } catch (err) {
        console.error(err);
        alert("‚ùå Error deleting image.");
      }
    };

    // ------------------ PDF UPLOAD ------------------
    window.submitPDF = async (e) => {
      e.preventDefault();
      const title = document.getElementById("pdfTitle").value.trim();
      const description = document.getElementById("pdfDescription").value.trim();
      const file = document.getElementById("pdfFileInput").files[0];
      const resultDiv = document.getElementById("pdfResult");

      if (!title || !description || !file) return alert("Please fill all fields and select a PDF.");
      resultDiv.innerHTML = "<p>Uploading PDF... Please wait.</p>";

      try {
        const url = `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`; // auto for PDFs
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);

        const res = await fetch(url, { method: "POST", body: formData });
        const data = await res.json();
        if (!data.secure_url) throw new Error("PDF upload failed.");

        await addDoc(collection(db, "pdf"), {
          title,
          description,
          fileUrl: data.secure_url,
          publicId: data.public_id,
          createdAt: serverTimestamp()
        });

        resultDiv.innerHTML = `<p style="color:lightgreen;">‚úÖ PDF Upload Successful!</p>`;
        document.getElementById("pdfUploadForm").reset();
        loadPDFs();
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "<p style='color:red;'>‚ùå PDF Upload failed</p>";
      }
    };

    async function loadPDFs() {
      const snapshot = await getDocs(collection(db, "pdf"));
      const listDiv = document.getElementById("pdfList");
      listDiv.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const div = document.createElement("div");
        div.style.margin = "20px 0";
        div.style.padding = "12px";
        div.style.background = "#1e293b";
        div.style.borderRadius = "8px";

        div.innerHTML = `
          <p><strong>${data.title}</strong></p>
          <p>${data.description}</p>
          <iframe src="${data.fileUrl}#toolbar=0" width="100%" height="400px" style="border-radius:8px; border:none;"></iframe>
          <br>
          <a href="${data.fileUrl}" target="_blank" style="color:#3b82f6; font-weight:bold;">üîó Open Full PDF</a><br>
          <button onclick="deletePDF('${id}', '${data.publicId}')">Delete</button>
        `;
        listDiv.appendChild(div);
      });
    }

    window.deletePDF = async (docId, publicId) => {
      if (!confirm("Are you sure you want to delete this PDF?")) return;
      try {
        await fetch("https://angelbeast-backend-1.onrender.com/delete-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ publicId })
        });
        await deleteDoc(doc(db, "pdf", docId));
        loadPDFs();
      } catch (err) {
        console.error(err);
        alert("‚ùå Error deleting PDF.");
      }
    };

    // ------------------ MENU SWITCH ------------------
    window.addEventListener('DOMContentLoaded', () => {
      const menuItems = document.querySelectorAll(".menu-item");
      const sections = document.querySelectorAll(".section");

      menuItems.forEach(item => {
        item.addEventListener("click", () => {
          document.getElementById("result").innerHTML = "";
          document.getElementById("pdfResult").innerHTML = "";
          menuItems.forEach(i => i.classList.remove("active"));
          sections.forEach(s => s.classList.remove("active"));
          item.classList.add("active");
          const sectionToShow = document.getElementById(item.dataset.section);
          if (sectionToShow) sectionToShow.classList.add("active");

          if (item.dataset.section === "manageImage") loadImages();
          if (item.dataset.section === "managePDF") loadPDFs();
        });
      });
    });
  </script>

  <style>
    body { font-family: Arial, sans-serif; background: #090e18; color: #e6eef8; margin:0; }
    .menu-bar { display:flex; gap:20px; padding:12px; background:#152036; justify-content:center; }
    .menu-item { cursor:pointer; padding:8px 16px; border-radius:8px; color:#94a3b8; font-weight:bold; }
    .menu-item.active, .menu-item:hover { background:#3b82f6; color:white; }
    .section { display:none; max-width:500px; margin:40px auto; padding:20px; background:#0f172a; border-radius:12px; }
    .section.active { display:block; }
    button { padding:8px 14px; border:none; border-radius:6px; background:#ef4444; color:white; cursor:pointer; }
    button:hover { background:#dc2626; }
  </style>
</head>
<body>
  <div class="menu-bar">
    <div class="menu-item active" data-section="uploadImage">Upload Image</div>
    <div class="menu-item" data-section="manageImage">Manage Images</div>
    <div class="menu-item" data-section="uploadPDF">Upload PDF</div>
    <div class="menu-item" data-section="managePDF">Manage PDFs</div>
  </div>

  <!-- IMAGE UPLOAD -->
  <div id="uploadImage" class="section active">
    <h2>Upload Image</h2>
    <form id="uploadForm" onsubmit="submitForm(event)">
      <input type="text" id="title" placeholder="Title" required><br>
      <textarea id="description" placeholder="Description" required></textarea><br>
      <input type="file" id="fileInput" accept="image/*" required><br>
      <button type="submit">Upload</button>
    </form>
    <div id="result"></div>
  </div>

  <!-- IMAGE MANAGE -->
  <div id="manageImage" class="section">
    <h2>Manage Images</h2>
    <div id="imageList"></div>
  </div>


<!-- PDF UPLOAD -->
<<!-- PDF UPLOAD & MANAGEMENT HTML/JS -->
<div id="uploadPDF" class="section">
  <h2>Add PDF via Google Drive Link</h2>
  <form id="pdfUploadForm" onsubmit="submitPDFLinkWithCover(event)">
    <input type="text" id="pdfTitle" placeholder="Title" required><br>
    <textarea id="pdfDescription" placeholder="Description" required></textarea><br>
    <input type="url" id="pdfLink" placeholder="Google Drive PDF Link" required><br>
    <input type="file" id="pdfCoverInput" accept="image/*" required><br>
    <button type="submit">Add PDF</button>
  </form>
  <div id="pdfResult"></div>
</div>

<div id="managePDF" class="section">
  <h2>Manage PDFs</h2>
  <div id="pdfList"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBNPSB13qV5YLoxMcc5YmuonTGDVkElBVg",
    authDomain: "lims-e4809.firebaseapp.com",
    projectId: "lims-e4809",
    storageBucket: "lims-e4809.firebasestorage.app",
    messagingSenderId: "702617555933",
    appId: "1:702617555933:web:db2f04cbb09f29354d9c34",
    measurementId: "G-W0KZRR52T2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const cloudName = "de2szhnwu";
  const uploadPreset = "limsailo3";

  // ------------------ PDF UPLOAD WITH COVER ------------------
  window.submitPDFLinkWithCover = async (e) => {
    e.preventDefault();

    const title = document.getElementById("pdfTitle").value.trim();
    const description = document.getElementById("pdfDescription").value.trim();
    const link = document.getElementById("pdfLink").value.trim();
    const coverFile = document.getElementById("pdfCoverInput").files[0];
    const resultDiv = document.getElementById("pdfResult");

    if (!title || !description || !link || !coverFile) {
      return alert("Please fill all fields, provide the PDF link, and select a cover image.");
    }

    resultDiv.innerHTML = "<p>Uploading cover and adding PDF link... Please wait.</p>";

    try {
      // Upload cover image to Cloudinary
      const formData = new FormData();
      formData.append("file", coverFile);
      formData.append("upload_preset", uploadPreset);

      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: "POST", body: formData });
      const data = await res.json();
      if (!data.secure_url) throw new Error("Cover upload failed.");

      // Save PDF info to Firestore
      await addDoc(collection(db, "pdf"), {
        title,
        description,
        fileUrl: link,
        coverUrl: data.secure_url,
        publicId: data.public_id, // For potential deletion of cover
        createdAt: serverTimestamp()
      });

      resultDiv.innerHTML = `<p style="color:lightgreen;">‚úÖ PDF added successfully!</p>`;
      document.getElementById("pdfUploadForm").reset();
      loadPDFs();
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = "<p style='color:red;'>‚ùå Failed to add PDF</p>";
    }
  };

  async function loadPDFs() {
    const snapshot = await getDocs(collection(db, "pdf"));
    const listDiv = document.getElementById("pdfList");
    listDiv.innerHTML = "";

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const id = docSnap.id;

      const div = document.createElement("div");
      div.style.margin = "20px 0";
      div.style.padding = "12px";
      div.style.background = "#1e293b";
      div.style.borderRadius = "8px";

      div.innerHTML = `
        <p><strong>${data.title}</strong></p>
        <img src="${data.coverUrl}" width="150" style="border-radius:8px; margin-bottom:8px;"><br>
        <p>${data.description}</p>
        <a href="${data.fileUrl}" target="_blank" style="color:#3b82f6; font-weight:bold;">üìÑ Open PDF</a><br>
        <button onclick="deletePDF('${id}', '${data.publicId}')">Delete</button>
      `;
      listDiv.appendChild(div);
    });
  }

  window.deletePDF = async (docId, publicId) => {
    if (!confirm("Are you sure you want to delete this PDF?")) return;
    try {
      // Optionally delete cover image from Cloudinary
      if (publicId) {
        await fetch("https://angelbeast-backend-1.onrender.com/delete-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ publicId })
        });
      }

      await deleteDoc(doc(db, "pdf", docId));
      loadPDFs();
    } catch (err) {
      console.error(err);
      alert("‚ùå Error deleting PDF.");
    }
  };

  // Load PDFs when "Manage PDFs" tab is opened
  window.addEventListener('DOMContentLoaded', () => {
    const menuItems = document.querySelectorAll(".menu-item");
    const sections = document.querySelectorAll(".section");

    menuItems.forEach(item => {
      item.addEventListener("click", () => {
        document.getElementById("pdfResult").innerHTML = "";
        menuItems.forEach(i => i.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        item.classList.add("active");

        const sectionToShow = document.getElementById(item.dataset.section);
        if (sectionToShow) sectionToShow.classList.add("active");

        if (item.dataset.section === "managePDF") loadPDFs();
      });
    });
  });
</script>


</body>
</html>
